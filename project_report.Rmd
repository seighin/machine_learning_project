---
title: "Machine Learning Project"
output: html_document
---

### Loading and preprocessing data
The data set is loaded and divided into a training set and testing set.

```{r}
pml <- read.csv('pml-training.csv')

library(caret)
set.seed(5555)
intrain <- createDataPartition(y=pml$classe, p=.75, list=F)
pml.train <- pml[intrain,]
pml.test <- pml[-intrain,]

cls <- pml.train[,"classe"]
cls.test <- pml.test[,"classe"]
```

The first seven columns, plus any column that is a factor or contains missing values is removed. This is for convience in performing the analysis.
```{r}
cols <- c()
for (i in 8:dim(pml.train)[2]){
    if (sum(is.na(pml[,i])) ==0 & ! is.factor(pml[,i])){
        cols <- c(cols, i)
    }
}

pml.train <- pml.train[,cols]
pml.test <- pml.test[, cols]
```

PCA preprocessing is performed to remove redundant information and speed the learning process.
```{r}
preProc <- preProcess(pml.train, method='pca')
pml.train.pp <- predict(preProc, pml.train)
pml.test.pp <- predict(preProc, pml.test)
```

The vectors of dummy variables for each class are created for the training set. 
```{r}
cls.A <- 1 * (cls=='A')
cls.B <- 1 * (cls=='B')
cls.C <- 1 * (cls=='C')
cls.D <- 1 * (cls=='D')
cls.E <- 1 * (cls=='E')


preProc <- preProcess(pml.train, method='pca')
pml.train.pp <- predict(preProc, pml.train)
pml.test.pp <- predict(preProc, pml.test)
```

### Training
A prediction value for each class is generated using a linear model.
```{r, cache=T}
fit.A <- train(cls.A~., data=pml.train.pp, method="glm")
pred.A <- predict(fit.A, pml.train.pp)

fit.B <- train(cls.B~., data=pml.train.pp, method="glm")
pred.B <- predict(fit.B, pml.train.pp)

fit.C <- train(cls.C~., data=pml.train.pp, method="glm")
pred.C <- predict(fit.C, pml.train.pp)

fit.D <- train(cls.D~., data=pml.train.pp, method="glm")
pred.D <- predict(fit.D, pml.train.pp)

fit.E <- train(cls.E~., data=pml.train.pp, method="glm")
pred.E <- predict(fit.E, pml.train.pp)

pred.m <- matrix(c(pred.A, pred.B, pred.C, pred.D, pred.E), ncol=5)
pred.max <- apply(pred.m, 1, max)
```

Results are generated by finding the maximum prediction value of the five classes.
```{r}
result <- rep('', nrow(pml.train))
result[pred.max==pred.A] <- 'A'
result[pred.max==pred.B] <- 'B'
result[pred.max==pred.C] <- 'C'
result[pred.max==pred.D] <- 'D'
result[pred.max==pred.E] <- 'E'

result.t <- table(cls,result)
result.acc <- sum(diag(result.t))/sum(result.t)
result.t
```

The accuracy of this simple prediction model is `r result.acc`. We expect the accuracy of the test set to be lower.

### Validating
```{r}
pred.test.A <- predict(fit.A, pml.test.pp)
pred.test.B <- predict(fit.B, pml.test.pp)
pred.test.C <- predict(fit.C, pml.test.pp)
pred.test.D <- predict(fit.D, pml.test.pp)
pred.test.E <- predict(fit.E, pml.test.pp)

pred.test.m <- matrix(c(pred.test.A, pred.test.B, pred.test.C, 
                        pred.test.D, pred.test.E), ncol=5)
pred.test.max <- apply(pred.test.m, 1, max)

result.test <- rep('', nrow(pml.test))
result.test[pred.test.max==pred.test.A] <- 'A'
result.test[pred.test.max==pred.test.B] <- 'B'
result.test[pred.test.max==pred.test.C] <- 'C'
result.test[pred.test.max==pred.test.D] <- 'D'
result.test[pred.test.max==pred.test.E] <- 'E'

result.test.t <- table(cls.test,result.test)
result.test.acc <- sum(diag(result.test.t))/sum(result.test.t)
result.test.t
```

The accuracy of the test set of this simple prediction model is `r result.test.acc`. Surprisingly, this is slightly higher than the training set.

### Test set (to be submitted)

```{r}
pml.sub <- read.csv('pml-testing.csv')

pml.sub <- pml.sub[, cols]
pml.sub.pp <- predict(preProc, pml.sub)

pred.sub.A <- predict(fit.A, pml.sub.pp)
pred.sub.B <- predict(fit.B, pml.sub.pp)
pred.sub.C <- predict(fit.C, pml.sub.pp)
pred.sub.D <- predict(fit.D, pml.sub.pp)
pred.sub.E <- predict(fit.E, pml.sub.pp)

pred.sub.m <- matrix(c(pred.sub.A, pred.sub.B, pred.sub.C, 
                        pred.sub.D, pred.sub.E), ncol=5)
pred.sub.max <- apply(pred.sub.m, 1, max)

result.sub <- rep('', nrow(pml.sub))
result.sub[pred.sub.max==pred.sub.A] <- 'A'
result.sub[pred.sub.max==pred.sub.B] <- 'B'
result.sub[pred.sub.max==pred.sub.C] <- 'C'
result.sub[pred.sub.max==pred.sub.D] <- 'D'
result.sub[pred.sub.max==pred.sub.E] <- 'E'

result.sub
```
